<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prediksi - BigData Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-gray-100">
    <!-- Navbar include -->
    {% include 'navbar.html' %}

    <div class="max-w-7xl mx-auto p-6">
      <h1 class="text-3xl font-bold mb-4">Prediksi Transaksi SARIMAX</h1>
      <p class="text-gray-700 mb-6">
        Data historis: <strong>01 Januari 2019 - 21 Juni 2020</strong> dengan prediksi ke depan
      </p>

      <!-- Form Dropdown Prediksi -->
      <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">
          <i class="fas fa-chart-line mr-2"></i>Pilih Periode Prediksi
        </h2>

        <div class="mb-4">
          <label class="block text-gray-700 font-medium mb-2" for="predictionDays">
            Prediksi untuk berapa hari ke depan?
          </label>
          <select
            id="predictionDays"
            onchange="updatePrediction()"
            class="w-full md:w-64 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
          >
            <option value="3">3 Hari</option>
            <option value="7" selected>7 Hari</option>
            <option value="30">30 Hari</option>
          </select>
        </div>

        <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
          <p class="text-sm text-blue-700">
            <i class="fas fa-info-circle mr-2"></i>
            Grafik akan menampilkan data historis dari 01 Januari 2019 sampai 21 Juni 2020, 
            ditambah prediksi sesuai pilihan Anda (3, 7, atau 30 hari ke depan).
          </p>
        </div>
      </div>

      <!-- Loading Indicator -->
      <div
        id="loading"
        class="hidden bg-blue-50 border-l-4 border-blue-500 p-4 mb-6"
      >
        <p class="text-blue-700">
          <i class="fas fa-spinner fa-spin mr-2"></i>Sedang memproses
          prediksi...
        </p>
      </div>

      <!-- Error Message -->
      <div
        id="error"
        class="hidden bg-red-50 border-l-4 border-red-500 p-4 mb-6"
      >
        <p class="text-red-700">
          <i class="fas fa-exclamation-circle mr-2"></i
          ><span id="errorMsg"></span>
        </p>
      </div>

      <!-- Hasil Visualisasi -->
      <div id="results" class="hidden">
        <!-- Info Summary -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg">
              <p class="text-gray-600 text-sm">Model</p>
              <p class="text-xl font-bold text-blue-600">SARIMAX</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
              <p class="text-gray-600 text-sm">Data Historis</p>
              <p class="text-lg font-bold text-green-600">01/01/2019 - 21/06/2020</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
              <p class="text-gray-600 text-sm">Periode Prediksi</p>
              <p class="text-xl font-bold text-purple-600" id="predPeriod">-</p>
            </div>
            <div class="bg-orange-50 p-4 rounded-lg">
              <p class="text-gray-600 text-sm">Akhir Prediksi</p>
              <p class="text-lg font-bold text-orange-600" id="endPredDate">-</p>
            </div>
          </div>
        </div>

        <!-- Grafik -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
          <h2 class="text-xl font-semibold mb-4">
            <i class="fas fa-chart-bar mr-2"></i>Grafik Data Historis & Prediksi
          </h2>
          <canvas id="predictionChart" class="w-full" height="80"></canvas>
        </div>

        <!-- Model Performance -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
          <h2 class="text-xl font-semibold mb-4">
            <i class="fas fa-chart-pie mr-2"></i>Goodness of Fit Model
          </h2>
          <div id="goodnessOfFit" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Will be populated by JS -->
          </div>
          <div class="mt-4 bg-gray-50 p-3 rounded text-sm text-gray-600">
            <p><strong>Interpretasi:</strong> AIC, BIC, dan HQIC semakin kecil menunjukkan model semakin optimal dan efisien.</p>
          </div>
        </div>

        <!-- Tabel Detail Prediksi -->
        <div class="bg-white shadow-md rounded-lg p-6">
          <h2 class="text-xl font-semibold mb-4">
            <i class="fas fa-table mr-2"></i>Detail Hasil Prediksi
          </h2>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    No
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Tanggal
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Prediksi Transaksi
                  </th>
                </tr>
              </thead>
              <tbody id="tableBody" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      let predictionChart = null;

      // Load data awal saat halaman dimuat
      window.addEventListener('DOMContentLoaded', () => {
        updatePrediction();
      });

      function updatePrediction() {
        const days = document.getElementById("predictionDays").value;
        
        // Reset UI
        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("error").classList.add("hidden");
        document.getElementById("results").classList.add("hidden");

        // Call API
        fetch("/prediksi/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            steps: parseInt(days),
            user_data: null
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("loading").classList.add("hidden");

            if (data.error) {
              document.getElementById("errorMsg").textContent = data.error;
              document.getElementById("error").classList.remove("hidden");
              return;
            }

            // Update info
            document.getElementById("predPeriod").textContent = days + " Hari";
            const lastPredDate = data.predictions[data.predictions.length - 1].date;
            document.getElementById("endPredDate").textContent = lastPredDate;

            // Update Goodness of Fit
            if (data.goodness_of_fit) {
              const gof = data.goodness_of_fit;
              document.getElementById("goodnessOfFit").innerHTML = `
                ${gof.aic ? `
                <div class="bg-blue-50 p-4 rounded-lg">
                  <p class="text-sm text-gray-600">AIC</p>
                  <p class="text-2xl font-bold text-blue-600">${gof.aic.toFixed(2)}</p>
                  <p class="text-xs text-gray-500 mt-1">Akaike Information Criterion</p>
                </div>` : ""}
                ${gof.bic ? `
                <div class="bg-indigo-50 p-4 rounded-lg">
                  <p class="text-sm text-gray-600">BIC</p>
                  <p class="text-2xl font-bold text-indigo-600">${gof.bic.toFixed(2)}</p>
                  <p class="text-xs text-gray-500 mt-1">Bayesian Information Criterion</p>
                </div>` : ""}
                ${gof.hqic ? `
                <div class="bg-purple-50 p-4 rounded-lg">
                  <p class="text-sm text-gray-600">HQIC</p>
                  <p class="text-2xl font-bold text-purple-600">${gof.hqic.toFixed(2)}</p>
                  <p class="text-xs text-gray-500 mt-1">Hannan-Quinn Information Criterion</p>
                </div>` : ""}
              `;
            }

            // Prepare chart data
            const predLabels = data.predictions.map((p) => p.date);
            const predValues = data.predictions.map((p) => p.predicted_transactions);

            // Update chart
            if (predictionChart) {
              predictionChart.destroy();
            }

            const ctx = document.getElementById("predictionChart").getContext("2d");
            predictionChart = new Chart(ctx, {
              type: "line",
              data: {
                labels: predLabels,
                datasets: [
                  {
                    label: "Prediksi Transaksi",
                    data: predValues,
                    borderColor: "rgb(59, 130, 246)",
                    backgroundColor: "rgba(59, 130, 246, 0.1)",
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2,
                  },
                ],
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    position: "top",
                  },
                  title: {
                    display: true,
                    text: "Grafik Prediksi Transaksi (Data Historis: 01/01/2019 - 21/06/2020)",
                    font: {
                      size: 16
                    }
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: "Jumlah Transaksi",
                    },
                  },
                  x: {
                    title: {
                      display: true,
                      text: "Tanggal",
                    },
                  },
                },
              },
            });

            // Update table
            const tableBody = document.getElementById("tableBody");
            tableBody.innerHTML = "";
            data.predictions.forEach((pred, index) => {
              const row = `
                <tr class="${index % 2 === 0 ? "bg-white" : "bg-gray-50"}">
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${pred.date}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">
                    ${Math.round(pred.predicted_transactions).toLocaleString()}
                  </td>
                </tr>
              `;
              tableBody.innerHTML += row;
            });

            // Show results
            document.getElementById("results").classList.remove("hidden");
          })
          .catch((error) => {
            document.getElementById("loading").classList.add("hidden");
            document.getElementById("errorMsg").textContent = "Terjadi kesalahan: " + error.message;
            document.getElementById("error").classList.remove("hidden");
          });
      }
    </script>
  </body>
</html>
