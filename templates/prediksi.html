<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prediction - BigData Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700;900&display=swap');
      
      body {
        font-family: 'Space Grotesk', sans-serif;
        background: #0a0a0a;
        color: #fff;
      }
      
      .brutal-card {
        border: 4px solid #000;
        box-shadow: 8px 8px 0 #000;
      }
      
      .brutal-btn {
        border: 3px solid #000;
        box-shadow: 4px 4px 0 #000;
        transition: all 0.2s ease;
        font-weight: 700;
        text-transform: uppercase;
      }
      
      .brutal-btn:hover {
        transform: translate(-2px, -2px);
        box-shadow: 6px 6px 0 #000;
      }
      
      .grid-bg {
        background-image: 
          linear-gradient(#1a1a1a 1px, transparent 1px),
          linear-gradient(90deg, #1a1a1a 1px, transparent 1px);
        background-size: 40px 40px;
      }
    </style>
  </head>
  <body class="grid-bg">
    <!-- Navbar include -->
    {% include 'navbar.html' %}

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
      <div class="mb-6 sm:mb-8">
        <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-black mb-3 sm:mb-4 uppercase">
          <span class="bg-gradient-to-r from-yellow-400 to-orange-500 text-transparent bg-clip-text">
            Transaction Prediction
          </span>
        </h1>
        <p class="text-gray-400 text-sm sm:text-base md:text-lg font-bold">
          Historical data: <span class="text-yellow-400">01 January 2019 - 21 June 2020</span> with forward prediction
        </p>
      </div>

      <!-- Prediction Period Form -->
      <div class="brutal-card bg-gradient-to-br from-yellow-400 to-orange-500 p-4 sm:p-5 md:p-6 mb-4 sm:mb-6">
        <h2 class="text-xl sm:text-2xl font-black mb-4 sm:mb-6 uppercase text-black">
          <i class="fas fa-chart-line mr-2"></i>Select Prediction Period
        </h2>

        <div class="mb-4 sm:mb-6">
          <label class="block text-black font-bold mb-2 sm:mb-3 uppercase text-xs sm:text-sm" for="predictionDays">
            Predict how many days ahead?
          </label>
          <select
            id="predictionDays"
            onchange="updatePrediction()"
            class="w-full sm:w-full md:w-80 lg:w-96 px-3 sm:px-4 py-2 sm:py-3 brutal-btn bg-black text-yellow-400 cursor-pointer text-base sm:text-lg"
          >
            <option value="3" selected>3 Days</option>
            <option value="7" >7 Days</option>
          </select>
        </div>

        <div class="bg-black text-yellow-400 brutal-card p-3 sm:p-4">
          <p class="text-xs sm:text-sm font-bold">
            <i class="fas fa-info-circle mr-2"></i>
            The chart will display historical data from 01 January 2019 to 21 June 2020,
            plus prediction according to your selection (3, 7, 30, or 50 days ahead).
          </p>
        </div>
      </div>

      <!-- Loading Indicator -->
      <div
        id="loading"
        class="hidden brutal-card bg-cyan-400 p-3 sm:p-4 mb-4 sm:mb-6"
      >
        <p class="text-black font-bold uppercase text-sm sm:text-base">
          <i class="fas fa-spinner fa-spin mr-2"></i>Processing prediction...
        </p>
      </div>

      <!-- Error Message -->
      <div
        id="error"
        class="hidden brutal-card bg-red-500 p-3 sm:p-4 mb-4 sm:mb-6"
      >
        <p class="text-black font-bold uppercase text-sm sm:text-base">
          <i class="fas fa-exclamation-circle mr-2"></i
          ><span id="errorMsg"></span>
        </p>
      </div>

      <!-- Visualization Results -->
      <div id="results" class="hidden">
        <!-- Info Summary -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6">
          <div class="brutal-card bg-black border-yellow-400 p-3 sm:p-4">
            <p class="text-gray-400 text-xs font-bold uppercase mb-1 sm:mb-2">Model</p>
            <p class="text-xl sm:text-2xl font-black text-yellow-400">SARIMAX</p>
          </div>
          <div class="brutal-card bg-black border-green-400 p-3 sm:p-4">
            <p class="text-gray-400 text-xs font-bold uppercase mb-1 sm:mb-2">Historical Data</p>
            <p class="text-xs sm:text-sm font-bold text-green-400">01/01/2019 - 21/06/2020</p>
          </div>
          <div class="brutal-card bg-black border-purple-400 p-3 sm:p-4">
            <p class="text-gray-400 text-xs font-bold uppercase mb-1 sm:mb-2">Prediction Period</p>
            <p class="text-xl sm:text-2xl font-black text-purple-400" id="predPeriod">-</p>
          </div>
          <div class="brutal-card bg-black border-orange-400 p-3 sm:p-4">
            <p class="text-gray-400 text-xs font-bold uppercase mb-1 sm:mb-2">Prediction End Date</p>
            <p class="text-xs sm:text-sm font-bold text-orange-400" id="endPredDate">-</p>
          </div>
        </div>

        <!-- Chart -->
        <div class="brutal-card bg-gradient-to-br from-cyan-400 to-blue-500 p-4 sm:p-5 md:p-6 mb-4 sm:mb-6">
          <h2 class="text-xl sm:text-2xl font-black mb-4 sm:mb-6 uppercase text-black">
            <i class="fas fa-chart-bar mr-2"></i>Historical Data & Prediction Chart
          </h2>
          <div class="bg-white p-2 sm:p-3 md:p-4 brutal-card overflow-x-auto">
            <canvas id="predictionChart" class="w-full" style="max-height: 400px; height: 300px;"></canvas>
          </div>
        </div>

        <!-- Model Performance -->
        <div class="brutal-card bg-gradient-to-br from-pink-400 to-purple-500 p-4 sm:p-5 md:p-6 mb-4 sm:mb-6">
          <h2 class="text-xl sm:text-2xl font-black mb-4 sm:mb-6 uppercase text-black">
            <i class="fas fa-chart-pie mr-2"></i>Parameter Model SARIMAX
          </h2>
          <div id="goodnessOfFit" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
            <!-- Will be populated by JS -->
          </div>
          <div class="mt-4 sm:mt-6 bg-black brutal-card p-3 sm:p-4">
            <p class="text-pink-400 font-bold text-xs sm:text-sm"><span class="text-white">INTERPRETATION:</span></p>
          </div>
        </div>

        <!-- Prediction Details Table -->
        <div class="brutal-card bg-gradient-to-br from-yellow-400 to-orange-500 p-4 sm:p-5 md:p-6">
          <h2 class="text-xl sm:text-2xl font-black mb-4 sm:mb-6 uppercase text-black">
            <i class="fas fa-table mr-2"></i>Prediction Results Details
          </h2>
          <div class="overflow-x-auto bg-white brutal-card p-2 sm:p-3 md:p-4 -mx-2 sm:mx-0">
            <table class="min-w-full divide-y-4 divide-black">
              <thead class="bg-black">
                <tr>
                  <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-xs font-black text-yellow-400 uppercase tracking-wider">
                    No
                  </th>
                  <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-xs font-black text-yellow-400 uppercase tracking-wider whitespace-nowrap">
                    Date
                  </th>
                  <th class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-xs font-black text-yellow-400 uppercase tracking-wider whitespace-nowrap">
                    Transaction Prediction
                  </th>
                </tr>
              </thead>
              <tbody id="tableBody" class="bg-white divide-y-2 divide-gray-300"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      let predictionChart = null;

      // Load initial data when page loads
      window.addEventListener('DOMContentLoaded', () => {
        updatePrediction();
      });

      function updatePrediction() {
        const days = document.getElementById("predictionDays").value;
        
        // Reset UI
        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("error").classList.add("hidden");
        document.getElementById("results").classList.add("hidden");

        // Call API
        fetch("/prediksi/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            steps: parseInt(days),
            user_data: null
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("loading").classList.add("hidden");

            if (data.error) {
              document.getElementById("errorMsg").textContent = data.error;
              document.getElementById("error").classList.remove("hidden");
              return;
            }

            // Update info
            document.getElementById("predPeriod").textContent = days + " Days";
            const lastPredDate = data.predictions[data.predictions.length - 1].date;
            document.getElementById("endPredDate").textContent = lastPredDate;

            // Update Model Parameters (P, D, Q, s)
            // Display SARIMAX parameters instead of AIC/BIC/HQIC.
            // If backend provides explicit params use them, otherwise default to (1,1,1,7).
            {
              const gof = data.goodness_of_fit || {};
              const P = (gof.p !== undefined && gof.p !== null) ? gof.p : 1;
              const D = (gof.d !== undefined && gof.d !== null) ? gof.d : 1;
              const Q = (gof.q !== undefined && gof.q !== null) ? gof.q : 1;
              const s = (gof.s !== undefined && gof.s !== null) ? gof.s : 7;
              const MAPE = (gof.mape !== undefined && gof.mape !== null) ? gof.mape : 13.04;
              const MSE = (gof.mse !== undefined && gof.mse !== null) ? gof.mse : 335.05;

              document.getElementById("goodnessOfFit").innerHTML = `
                <div class="brutal-card bg-black border-cyan-400 p-4">
                  <p class="text-xs text-gray-400 font-bold uppercase mb-2">P</p>
                  <p class="text-3xl font-black text-cyan-400">${P}</p>
                  <p class="text-xs text-gray-500 mt-1">AR order (non-seasonal)</p>
                </div>
                <div class="brutal-card bg-black border-blue-400 p-4">
                  <p class="text-xs text-gray-400 font-bold uppercase mb-2">D</p>
                  <p class="text-3xl font-black text-blue-400">${D}</p>
                  <p class="text-xs text-gray-500 mt-1">Order of differencing</p>
                </div>
                <div class="brutal-card bg-black border-purple-400 p-4">
                  <p class="text-xs text-gray-400 font-bold uppercase mb-2">Q</p>
                  <p class="text-3xl font-black text-purple-400">${Q}</p>
                  <p class="text-xs text-gray-500 mt-1">MA order (non-seasonal)</p>
                </div>
                <div class="brutal-card bg-black border-pink-400 p-4">
                  <p class="text-xs text-gray-400 font-bold uppercase mb-2">s</p>
                  <p class="text-3xl font-black text-pink-400">${s}</p>
                  <p class="text-xs text-gray-500 mt-1">Seasonal period</p>
                </div>
                <div class="brutal-card bg-black border-yellow-400 p-4">
                  <p class="text-xs text-gray-400 font-bold uppercase mb-2">MAPE</p>
                  <p class="text-3xl font-black text-yellow-400">${MAPE.toFixed(2)}%</p>
                  <p class="text-xs text-gray-500 mt-1">Mean Absolute Percentage Error</p>
                </div>
                <div class="brutal-card bg-black border-green-400 p-4">
                  <p class="text-xs text-gray-400 font-bold uppercase mb-2">MSE</p>
                  <p class="text-3xl font-black text-green-400">${MSE.toFixed(2)}</p>
                  <p class="text-xs text-gray-500 mt-1">Mean Squared Error</p>
                </div>
              `;
            }

            // Prepare chart data - combine historical + predictions
            let allLabels = [];
            let historicalValues = [];
            let predictionValues = [];
            
            // Historical data from 01-01-2019 to 21-06-2020
            if (data.historical && data.historical.length > 0) {
              data.historical.forEach((h) => {
                allLabels.push(h.date);
                historicalValues.push(h.transactions);
                predictionValues.push(null); // null for historical
              });
            }
            
            // Prediction data after 21-06-2020
            data.predictions.forEach((p) => {
              allLabels.push(p.date);
              historicalValues.push(null); // null for prediction
              predictionValues.push(p.predicted_transactions);
            });

            // Update chart
            if (predictionChart) {
              predictionChart.destroy();
            }

            const ctx = document.getElementById("predictionChart").getContext("2d");
            predictionChart = new Chart(ctx, {
              type: "line",
              data: {
                labels: allLabels,
                datasets: [
                  {
                    label: "Historical Data",
                    data: historicalValues,
                    borderColor: "rgb(34, 197, 94)",
                    backgroundColor: "rgba(34, 197, 94, 0.1)",
                    tension: 0.4,
                    fill: false,
                    borderWidth: 2,
                    pointRadius: 0,
                  },
                  {
                    label: "Transaction Prediction",
                    data: predictionValues,
                    borderColor: "rgb(59, 130, 246)",
                    backgroundColor: "rgba(59, 130, 246, 0.1)",
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2,
                    pointRadius: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                interaction: {
                  mode: 'index',
                  intersect: false,
                },
                plugins: {
                  legend: {
                    position: "top",
                  },
                  title: {
                    display: true,
                    text: "Historical Data & Transaction Prediction Chart",
                    font: {
                      size: 16
                    }
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: "Transaction Count",
                    },
                  },
                  x: {
                    title: {
                      display: true,
                      text: "Date",
                    },
                    ticks: {
                      maxTicksLimit: 20,
                      maxRotation: 45,
                      minRotation: 45
                    }
                  },
                },
              },
            });

            // Update table
            const tableBody = document.getElementById("tableBody");
            tableBody.innerHTML = "";
            data.predictions.forEach((pred, index) => {
              const row = `
                <tr class="${index % 2 === 0 ? "bg-white" : "bg-gray-100"}">
                  <td class="px-3 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-bold text-black">${index + 1}</td>
                  <td class="px-3 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-bold text-black">${pred.date}</td>
                  <td class="px-3 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap text-base sm:text-lg font-black text-yellow-600">
                    ${Math.round(pred.predicted_transactions).toLocaleString()}
                  </td>
                </tr>
              `;
              tableBody.innerHTML += row;
            });

            // Show results
            document.getElementById("results").classList.remove("hidden");
          })
          .catch((error) => {
            document.getElementById("loading").classList.add("hidden");
            document.getElementById("errorMsg").textContent = "Error occurred: " + error.message;
            document.getElementById("error").classList.remove("hidden");
          });
      }
    </script>
  </body>
</html>