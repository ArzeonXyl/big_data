<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prediksi - BigData Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700;900&display=swap');
      
      body {
        font-family: 'Space Grotesk', sans-serif;
        background: #0a0a0a;
        color: #fff;
      }
      
      .brutal-card {
        border: 4px solid #000;
        box-shadow: 8px 8px 0 #000;
      }
      
      .brutal-btn {
        border: 3px solid #000;
        box-shadow: 4px 4px 0 #000;
        transition: all 0.2s ease;
        font-weight: 700;
        text-transform: uppercase;
      }
      
      .brutal-btn:hover {
        transform: translate(-2px, -2px);
        box-shadow: 6px 6px 0 #000;
      }
      
      .grid-bg {
        background-image: 
          linear-gradient(#1a1a1a 1px, transparent 1px),
          linear-gradient(90deg, #1a1a1a 1px, transparent 1px);
        background-size: 40px 40px;
      }
    </style>
  </head>
  <body class="grid-bg">
    <!-- Navbar include -->
    {% include 'navbar.html' %}

    <div class="max-w-7xl mx-auto p-6">
      <div class="mb-8">
        <h1 class="text-5xl md:text-6xl font-black mb-4 uppercase">
          <span class="bg-gradient-to-r from-yellow-400 to-orange-500 text-transparent bg-clip-text">
            Prediksi Transaksi
          </span>
        </h1>
        <p class="text-gray-400 text-lg font-bold">
          Data historis: <span class="text-yellow-400">01 Januari 2019 - 21 Juni 2020</span> dengan prediksi ke depan
        </p>
      </div>

      <!-- Form Dropdown Prediksi -->
      <div class="brutal-card bg-gradient-to-br from-yellow-400 to-orange-500 p-6 mb-6">
        <h2 class="text-2xl font-black mb-6 uppercase text-black">
          <i class="fas fa-chart-line mr-2"></i>Pilih Periode Prediksi
        </h2>

        <div class="mb-6">
          <label class="block text-black font-bold mb-3 uppercase text-sm" for="predictionDays">
            Prediksi untuk berapa hari ke depan?
          </label>
          <select
            id="predictionDays"
            onchange="updatePrediction()"
            class="w-full md:w-64 px-4 py-3 brutal-btn bg-black text-yellow-400 cursor-pointer text-lg"
          >
            <option value="3">3 Hari</option>
            <option value="7" selected>7 Hari</option>
            <option value="30">30 Hari</option>
            <option value="50">50 Hari</option>
          </select>
        </div>

        <div class="bg-black text-yellow-400 brutal-card p-4">
          <p class="text-sm font-bold">
            <i class="fas fa-info-circle mr-2"></i>
            Grafik akan menampilkan data historis dari 01 Januari 2019 sampai 21 Juni 2020, 
            ditambah prediksi sesuai pilihan Anda (3, 7, 30, atau 50 hari ke depan).
          </p>
        </div>
      </div>

      <!-- Loading Indicator -->
      <div
        id="loading"
        class="hidden brutal-card bg-cyan-400 p-4 mb-6"
      >
        <p class="text-black font-bold uppercase">
          <i class="fas fa-spinner fa-spin mr-2"></i>Sedang memproses
          prediksi...
        </p>
      </div>

      <!-- Error Message -->
      <div
        id="error"
        class="hidden brutal-card bg-red-500 p-4 mb-6"
      >
        <p class="text-black font-bold uppercase">
          <i class="fas fa-exclamation-circle mr-2"></i
          ><span id="errorMsg"></span>
        </p>
      </div>

      <!-- Hasil Visualisasi -->
      <div id="results" class="hidden">
        <!-- Info Summary -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="brutal-card bg-black border-yellow-400 p-4">
            <p class="text-gray-400 text-xs font-bold uppercase mb-2">Model</p>
            <p class="text-2xl font-black text-yellow-400">SARIMAX</p>
          </div>
          <div class="brutal-card bg-black border-green-400 p-4">
            <p class="text-gray-400 text-xs font-bold uppercase mb-2">Data Historis</p>
            <p class="text-sm font-bold text-green-400">01/01/2019 - 21/06/2020</p>
          </div>
          <div class="brutal-card bg-black border-purple-400 p-4">
            <p class="text-gray-400 text-xs font-bold uppercase mb-2">Periode Prediksi</p>
            <p class="text-2xl font-black text-purple-400" id="predPeriod">-</p>
          </div>
          <div class="brutal-card bg-black border-orange-400 p-4">
            <p class="text-gray-400 text-xs font-bold uppercase mb-2">Akhir Prediksi</p>
            <p class="text-sm font-bold text-orange-400" id="endPredDate">-</p>
          </div>
        </div>

        <!-- Grafik -->
        <div class="brutal-card bg-gradient-to-br from-cyan-400 to-blue-500 p-6 mb-6">
          <h2 class="text-2xl font-black mb-6 uppercase text-black">
            <i class="fas fa-chart-bar mr-2"></i>Grafik Data Historis & Prediksi
          </h2>
          <div class="bg-white p-4 brutal-card">
            <canvas id="predictionChart" class="w-full" height="80"></canvas>
          </div>
        </div>

        <!-- Model Performance -->
        <div class="brutal-card bg-gradient-to-br from-pink-400 to-purple-500 p-6 mb-6">
          <h2 class="text-2xl font-black mb-6 uppercase text-black">
            <i class="fas fa-chart-pie mr-2"></i>Goodness of Fit Model
          </h2>
          <div id="goodnessOfFit" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Will be populated by JS -->
          </div>
          <div class="mt-6 bg-black brutal-card p-4">
            <p class="text-pink-400 font-bold text-sm"><span class="text-white">INTERPRETASI:</span> AIC, BIC, dan HQIC semakin kecil menunjukkan model semakin optimal dan efisien.</p>
          </div>
        </div>

        <!-- Tabel Detail Prediksi -->
        <div class="brutal-card bg-gradient-to-br from-yellow-400 to-orange-500 p-6">
          <h2 class="text-2xl font-black mb-6 uppercase text-black">
            <i class="fas fa-table mr-2"></i>Detail Hasil Prediksi
          </h2>
          <div class="overflow-x-auto bg-white brutal-card p-4">
            <table class="min-w-full divide-y-4 divide-black">
              <thead class="bg-black">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-black text-yellow-400 uppercase tracking-wider">
                    No
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-black text-yellow-400 uppercase tracking-wider">
                    Tanggal
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-black text-yellow-400 uppercase tracking-wider">
                    Prediksi Transaksi
                  </th>
                </tr>
              </thead>
              <tbody id="tableBody" class="bg-white divide-y-2 divide-gray-300"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      let predictionChart = null;

      // Load data awal saat halaman dimuat
      window.addEventListener('DOMContentLoaded', () => {
        updatePrediction();
      });

      function updatePrediction() {
        const days = document.getElementById("predictionDays").value;
        
        // Reset UI
        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("error").classList.add("hidden");
        document.getElementById("results").classList.add("hidden");

        // Call API
        fetch("/prediksi/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            steps: parseInt(days),
            user_data: null
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("loading").classList.add("hidden");

            if (data.error) {
              document.getElementById("errorMsg").textContent = data.error;
              document.getElementById("error").classList.remove("hidden");
              return;
            }

            // Update info
            document.getElementById("predPeriod").textContent = days + " Hari";
            const lastPredDate = data.predictions[data.predictions.length - 1].date;
            document.getElementById("endPredDate").textContent = lastPredDate;

            // Update Goodness of Fit
            if (data.goodness_of_fit) {
              const gof = data.goodness_of_fit;
              document.getElementById("goodnessOfFit").innerHTML = `
                ${gof.aic ? `
                <div class="brutal-card bg-black border-cyan-400 p-4">
                  <p class="text-xs text-gray-400 font-bold uppercase mb-2">AIC</p>
                  <p class="text-3xl font-black text-cyan-400">${gof.aic.toFixed(2)}</p>
                  <p class="text-xs text-gray-500 mt-1">Akaike Information Criterion</p>
                </div>` : ""}
                ${gof.bic ? `
                <div class="brutal-card bg-black border-blue-400 p-4">
                  <p class="text-xs text-gray-400 font-bold uppercase mb-2">BIC</p>
                  <p class="text-3xl font-black text-blue-400">${gof.bic.toFixed(2)}</p>
                  <p class="text-xs text-gray-500 mt-1">Bayesian Information Criterion</p>
                </div>` : ""}
                ${gof.hqic ? `
                <div class="brutal-card bg-black border-purple-400 p-4">
                  <p class="text-xs text-gray-400 font-bold uppercase mb-2">HQIC</p>
                  <p class="text-3xl font-black text-purple-400">${gof.hqic.toFixed(2)}</p>
                  <p class="text-xs text-gray-500 mt-1">Hannan-Quinn Information Criterion</p>
                </div>` : ""}
              `;
            }

            // Prepare chart data - gabungkan historical + predictions
            let allLabels = [];
            let historicalValues = [];
            let predictionValues = [];
            
            // Data historis dari 01-01-2019 sampai 21-06-2020
            if (data.historical && data.historical.length > 0) {
              data.historical.forEach((h) => {
                allLabels.push(h.date);
                historicalValues.push(h.transactions);
                predictionValues.push(null); // null untuk historical
              });
            }
            
            // Data prediksi setelah 21-06-2020
            data.predictions.forEach((p) => {
              allLabels.push(p.date);
              historicalValues.push(null); // null untuk prediksi
              predictionValues.push(p.predicted_transactions);
            });

            // Update chart
            if (predictionChart) {
              predictionChart.destroy();
            }

            const ctx = document.getElementById("predictionChart").getContext("2d");
            predictionChart = new Chart(ctx, {
              type: "line",
              data: {
                labels: allLabels,
                datasets: [
                  {
                    label: "Data Historis",
                    data: historicalValues,
                    borderColor: "rgb(34, 197, 94)",
                    backgroundColor: "rgba(34, 197, 94, 0.1)",
                    tension: 0.4,
                    fill: false,
                    borderWidth: 2,
                    pointRadius: 0,
                  },
                  {
                    label: "Prediksi Transaksi",
                    data: predictionValues,
                    borderColor: "rgb(59, 130, 246)",
                    backgroundColor: "rgba(59, 130, 246, 0.1)",
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2,
                    pointRadius: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                interaction: {
                  mode: 'index',
                  intersect: false,
                },
                plugins: {
                  legend: {
                    position: "top",
                  },
                  title: {
                    display: true,
                    text: "Grafik Data Historis & Prediksi Transaksi",
                    font: {
                      size: 16
                    }
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: "Jumlah Transaksi",
                    },
                  },
                  x: {
                    title: {
                      display: true,
                      text: "Tanggal",
                    },
                    ticks: {
                      maxTicksLimit: 20,
                      maxRotation: 45,
                      minRotation: 45
                    }
                  },
                },
              },
            });

            // Update table
            const tableBody = document.getElementById("tableBody");
            tableBody.innerHTML = "";
            data.predictions.forEach((pred, index) => {
              const row = `
                <tr class="${index % 2 === 0 ? "bg-white" : "bg-gray-100"}">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-black">${index + 1}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-black">${pred.date}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-lg font-black text-yellow-600">
                    ${Math.round(pred.predicted_transactions).toLocaleString()}
                  </td>
                </tr>
              `;
              tableBody.innerHTML += row;
            });

            // Show results
            document.getElementById("results").classList.remove("hidden");
          })
          .catch((error) => {
            document.getElementById("loading").classList.add("hidden");
            document.getElementById("errorMsg").textContent = "Terjadi kesalahan: " + error.message;
            document.getElementById("error").classList.remove("hidden");
          });
      }
    </script>
  </body>
</html>
